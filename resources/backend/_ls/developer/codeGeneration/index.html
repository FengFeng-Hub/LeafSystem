<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>列表页面</title>
    <style>
        /* 表头居中 */
        .ls-container .ant-table-thead > tr > th {
            text-align: center;
        }
    </style>
</head>
<body>
<div class="ls-card ls-container">
    <a-button v-if="pageParams.backMenu" size="small" @click="QiankunUtil.toPage('/backend/systemManage/menu/index.html', {
		...{menu_name: '菜单管理'}, ...pageParams.backMenu
	})" style="margin-right: 10px;"><a-icon type="rollback"></a-icon> 返回</a-button>
    <b>代码生成</b>
    <a-divider></a-divider>
    <div class="ls-table-tool">
        <a-input-group compact style="width: 350px;">
            <a-select v-model="searchConfig.searchType" style="width: 100px;">
                <a-select-option value="table_name">表名称</a-select-option>
                <a-select-option value="table_comment">备注</a-select-option>
            </a-select>
            <a-select v-model="searchConfig.IsEqual" style="width: 70px;">
                <a-select-option value="0">包含</a-select-option>
                <a-select-option value="1">等于</a-select-option>
            </a-select>
            <a-input v-model="searchConfig.searchKey" placeholder="请输入搜索关键字" style="width: calc(100% - 170px);"/>
        </a-input-group>
        <a-button type="primary" @click="search(false)"><a-icon type="search"></a-icon> 搜索</a-button>
        <a-button @click="search(true)"><a-icon type="sync"></a-icon> 重置</a-button>
    </div>
    <a-table
        :columns="tableColumns"
        :data-source="tableData"
        :pagination="tablePagination"
        @change="handleTableChange"
        :loading="tableLoading"
        :scroll="{ x: 1150 }"
        size="small" bordered
    >
        <template slot="action" slot-scope="text, record">
            <a-button type="link" size="small" title="编辑" @click="edit(record)" :disabled="!$ls.hasPermission('lspk:ls:codeGeneration:DBTableFieldInfo')"><a-icon type="edit"></a-icon></a-button>
        </template>
    </a-table>
</div>
</div>
</body>
<script>
    function init(props, params) {
        let _this = null;

        new Vue({
            el: ".ls-container",
            data: {
                pageParams: params,
                // 表格字段
                tableColumns: [{
                    title: '', width: 50, scopedSlots: { customRender: 'action' }
                }, {
                    title: '表名称', dataIndex: 'table_name', align: 'center', width: 200
                }, {
                    title: '备注', dataIndex: 'table_comment', minWidth: 200
                }, {
                    title: '所属的数据库', dataIndex: 'table_schema', align: 'center', width: 200
                }, {
                    title: '创建时间', dataIndex: 'create_time', align: 'center', width: 150
                }, {
                    title: '更新时间', dataIndex: 'update_time', align: 'center', width: 150
                }, {
                    title: '数据条数', dataIndex: 'table_rows', align: 'center', width: 100
                }, {
                    title: '自增', dataIndex: 'auto_increment', align: 'center', width: 100
                }],
                // 表格数据
                tableData: [],
                tableLoading: false,
                // 表格分页配置
                tablePagination: {
                    pageSize: 10, // 每页显示的条数
                    showSizeChanger: true, // 是否可以改变每页显示的条数
                    pageSizeOptions: [1, 2, 5, 10, 30, 50, 100, 200, 300, 500, 600, 700, 800, 900, 1000], // 可选的每页显示条数
                    showQuickJumper: true, // 是否可以快速跳转到指定页
                    showTotal: total => `共 ${total} 条`, // 显示总条数和当前数据范围
                    current: 1, // 当前页数
                    total: 0 // 总条数
                },
                // 搜索配置
                searchConfig: {
                    searchType: 'table_name',
                    searchKey: '',
                    IsEqual: '0',
                    model: {},
                    params: {}
                }
            },
            created() {
                _this = this;
                // 加载数据
                this.loadTableList({
                    PageNo: params.page?params.page:this.tablePagination.current,
                    PageCount: params.pageSize?params.pageSize:this.tablePagination.pageSize
                });
                // this.edit({
                //     table_name: 'test_student',
                //     table_comment: '测试学生表'
                // })
            },
            mounted() {},
            methods: {
                handleTableChange(pagination, filters, sorter) {
                    this.loadTableList({
                        ...{
                            PageNo: pagination.current,
                            PageCount: pagination.pageSize
                        }, ...filters
                    });
                },
                // 加载表格列表
                loadTableList(params) {
                    this.tableLoading = true;
                    Ajax.get({
                        url: '/system/api/codeGeneration/getDBTableInfo',
                        param: {...params, ...this.searchConfig.params},
                        success(result) {
                            if(result.IsSuccess === '1') {
                                _this.tableData = result.data;
                                _this.tablePagination.total = result.dataCount;
                                _this.tableLoading = false;
                            } else {
                                _this.$message.error(result.Msg);
                            }
                        }
                    });
                    this.tablePagination.pageSize = params.PageCount;
                    this.tablePagination.current = params.PageNo;
                },
                // 搜索
                search(isReset) {
                    for (const key in this.searchConfig.params) {
                        delete this.searchConfig.params[key]
                    }

                    if (!isReset) {
                        this.searchConfig.params = Object.assign({},this.searchConfig.model);
                        this.searchConfig.params[this.searchConfig.searchType] = this.searchConfig.searchKey;
                        this.tablePagination.current = 1;
                    }

                    this.loadTableList({
                        PageNo: 1,
                        PageCount: params.pageSize?params.pageSize:this.tablePagination.pageSize
                    });
                },
                edit(record) {
                    QiankunUtil.toPage(props.parentUrl + 'edit.html', {
                        table_name: record.table_name,
                        table_comment: record.table_comment,
                        page: this.tablePagination.current,
                        pageSize: this.tablePagination.pageSize
                    });
                }
            }
        });
    }

    // 获取qiankun子应用生命周期
    QiankunUtil.getLifecycles({
        mount(props) {
            init(props, props.params);
        }
    });
</script>
</html>